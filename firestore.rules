rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user is admin
    function isAdmin() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'superadmin', 'super_admin'];
    }
    
    // Helper function to check if user is department head
    function isDepartmentHead() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'department_head';
    }
    
    // Helper function to check if user is president
    function isPresident() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'president';
    }
    
    // Users collection
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.auth.uid == userId;
      allow update: if isAuthenticated() && (request.auth.uid == userId || isAdmin());
      allow delete: if isAdmin();
    }
    
    // Reports collection
    match /reports/{reportId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated() && 
                     (resource.data.authorId == request.auth.uid || isAdmin());
    }
    
    // Comments collection
    match /comments/{commentId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && 
                     (resource.data.userId == request.auth.uid || isAdmin());
    }
    
    // Votes collection
    match /votes/{voteId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Views collection
    match /views/{viewId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAdmin();
    }
    
    // Notifications collection
    match /notifications/{notificationId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Chats collection
    match /chats/{chatId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAdmin();
    }
    
    // Analytics collection
    match /analytics/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // Test Feedback collection
    match /testFeedback/{feedbackId} {
      allow read: if isAdmin();
      allow create: if isAuthenticated();
      allow delete: if isAdmin();
    }
    
    // Usage Logs collection
    match /usageLogs/{logId} {
      allow read: if isAdmin();
      allow create: if isAuthenticated();
      allow delete: if isAdmin();
    }
    
    // Appeals collection (ISO 21001:2018 Complaint Appeals)
    match /appeals/{appealId} {
      // Users can read their own appeals, admins/dept heads/presidents can read all
      allow read: if isAuthenticated() && 
                     (resource.data.userId == request.auth.uid || 
                      isAdmin() || 
                      isDepartmentHead() || 
                      isPresident());
      
      // Users can only create appeals for their own rejected reports
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid;
      
      // Admins can update appeals in stages 1-3 (submission, review, documentation, forwarding)
      // Department heads can update appeals in stage 4-5 (department review, proposal)
      // Presidents can update appeals in stage 6-7 (decision, approval/disapproval)
      // Admins can complete appeals in stage 8-10
      allow update: if isAuthenticated() && (
                       (isAdmin() && resource.data.currentStage <= 7) ||
                       (isDepartmentHead() && resource.data.currentStage in [4, 5]) ||
                       (isPresident() && resource.data.currentStage in [6, 7])
                     );
      
      // Only admins can delete appeals (for cleanup/moderation)
      // Completed appeals should not be deleted for audit trail
      allow delete: if isAdmin() && resource.data.status != 'completed';
    }
    
    // Conversations collection (NEW - for user-admin messaging)
    match /conversations/{conversationId} {
      allow read: if isAuthenticated() && 
                     (resource.data.userId == request.auth.uid || isAdmin());
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && 
                       (resource.data.userId == request.auth.uid || isAdmin());
      allow delete: if isAdmin();
      
      // Messages subcollection
      match /messages/{messageId} {
        allow read: if isAuthenticated() && 
                       (get(/databases/$(database)/documents/conversations/$(conversationId)).data.userId == request.auth.uid || 
                        isAdmin());
        allow create: if isAuthenticated() && 
                         (get(/databases/$(database)/documents/conversations/$(conversationId)).data.userId == request.auth.uid || 
                          isAdmin());
        allow update: if isAuthenticated() && 
                         (get(/databases/$(database)/documents/conversations/$(conversationId)).data.userId == request.auth.uid || 
                          isAdmin());
        allow delete: if isAdmin();
      }
    }
  }
}
